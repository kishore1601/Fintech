@if (authService.isLoggedIn()) {
<div class="dashboard-container" (click)="showSettingsMenu.set(false)">
  <!-- Top Nav -->
  <nav class="top-nav">
    <div class="logo">KishoreFintech</div>
    <div class="nav-links">
      <span class="nav-item" [class.active]="currentTab() === 'dashboard'"
        (click)="switchTab('dashboard')">Dashboard</span>
      <span class="nav-item" [class.active]="currentTab() === 'loans'" (click)="switchTab('loans')">Directory</span>
      <span class="nav-item" [class.active]="currentTab() === 'borrowers'"
        (click)="switchTab('borrowers')">Statistics</span>
    </div>

    <!-- Right Side Actions -->
    <div style="display: flex; align-items: center; gap: 2rem;">
      <!-- Settings Link with Dropdown -->
      <div class="nav-item" style="display: flex; align-items: center; gap: 8px; position: relative;"
        [class.active]="showSettingsMenu()"
        (click)="$event.stopPropagation(); showSettingsMenu.set(!showSettingsMenu())">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"></circle>
          <path
            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
          </path>
        </svg>
        <span>Settings</span>

        <!-- Compact Dropdown Menu -->
        <div *ngIf="showSettingsMenu()" class="glass glass-card"
          style="position: absolute; top: 120%; right: 0; min-width: 220px; padding: 0.5rem; z-index: 1000; border-radius: 16px; display: flex; flex-direction: column; gap: 4px;">

          <!-- Logout -->
          <button class="btn-danger-compact"
            style="display: flex; align-items: center; gap: 10px; width: 100%; border: none; background: rgba(239, 68, 68, 0.1); color: var(--error); padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600;"
            (click)="authService.logout()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Log Out
          </button>

          <!-- Theme Toggle -->
          <button
            style="display: flex; align-items: center; gap: 10px; width: 100%; border: none; background: transparent; color: var(--text-pure); padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.2s;"
            (click)="$event.stopPropagation(); themeService.toggleTheme()"
            onmouseover="this.style.background='rgba(255,255,255,0.05)'"
            onmouseout="this.style.background='transparent'">
            <span>{{ themeService.darkMode() ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode' }}</span>
          </button>

          <!-- Divider -->
          <div style="height: 1px; background: var(--glass-border); margin: 2px 0;"></div>

          <!-- Export Data -->
          <button
            style="display: flex; align-items: center; gap: 10px; width: 100%; border: none; background: transparent; color: var(--text-pure); padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.2s;"
            (click)="$event.stopPropagation(); loanService.exportData(); showSettingsMenu.set(false)"
            onmouseover="this.style.background='rgba(255,255,255,0.05)'"
            onmouseout="this.style.background='transparent'">
            <span>üì¶ Export Backup</span>
          </button>

          <!-- Import Data -->
          <button
            style="display: flex; align-items: center; gap: 10px; width: 100%; border: none; background: transparent; color: var(--text-pure); padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.2s;"
            (click)="$event.stopPropagation(); importFileInput.click()"
            onmouseover="this.style.background='rgba(255,255,255,0.05)'"
            onmouseout="this.style.background='transparent'">
            <span>üì• Import Backup</span>
          </button>
          <input #importFileInput type="file" accept=".json" style="display: none;"
            (change)="handleImportFile($event); showSettingsMenu.set(false)">

          <!-- About -->
          <div style="padding: 0.6rem 1rem; border-top: 1px solid var(--glass-border); margin-top: 4px;">
            <div style="font-size: 0.8rem; font-weight: 700; color: var(--text-pure);">About</div>
            <div style="font-size: 0.75rem; color: var(--text-med);">v1.0.0</div>
          </div>

          <!-- Profile Settings Button -->
          <button
            style="display: flex; align-items: center; gap: 10px; width: 100%; border: none; background: transparent; color: var(--text-pure); padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.2s;"
            (click)="$event.stopPropagation(); switchTab('settings'); showSettingsMenu.set(false)"
            onmouseover="this.style.background='rgba(255,255,255,0.05)'"
            onmouseout="this.style.background='transparent'">
            <span>‚öôÔ∏è Profile Settings</span>
          </button>
        </div>
      </div>

      <div class="user-profile" style="display: none;">
      </div>
    </div>
  </nav>

  <!-- Offline Indicator -->
  <div class="offline-banner" *ngIf="loanService.isOffline()">
    <span>üì°</span> You're offline ‚Äî showing cached data
  </div>
  <main class="main-content">
    @if (selectedBorrower()) {
    <!-- Breadcrumb / Back Button -->
    <button class="btn-back" (click)="selectedBorrower.set(null)">
      <span>‚Üê</span> Back to Directory
    </button>

    <div class="header-actions" style="margin-bottom: 2rem;">
      <div style="display: flex; align-items: center; gap: 24px;">
        <h1 style="margin: 0; font-size: 2.2rem; font-weight: 800;" *ngIf="!isEditingName()">
          {{ selectedBorrower() }}
          <button (click)="startEditingName()"
            style="background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.5; transition: opacity 0.2s;"
            title="Rename Borrower">‚úèÔ∏è</button>
        </h1>
        <div *ngIf="isEditingName()" style="display: flex; gap: 8px; align-items: center;">
          <input [ngModel]="newNameEdit()" (ngModelChange)="newNameEdit.set($event)" class="ledger-input"
            style="font-size: 1.5rem; font-weight: 700; width: 300px;">
          <button class="btn-primary" (click)="saveName()" style="padding: 0.5rem 1rem;">Save</button>
          <button class="btn-danger" (click)="cancelNameEdit()" style="padding: 0.5rem 0.8rem;">‚úï</button>
        </div>

        <button class="btn-danger-compact glowing" *ngIf="selectedTransactionIds().size > 0" (click)="deleteSelected()"
          style="height: 38px; border-radius: 12px; padding: 0 1.25rem;">
          üóëÔ∏è Delete Selected ({{ selectedTransactionIds().size }})
        </button>
      </div>
      <div style="display: flex; gap: 12px;">
        <button class="btn-primary" (click)="openAddTransaction()" *ngIf="!isAddingHistoryEntry()">
          ‚ûï Lend
        </button>
        <button class="btn-primary" (click)="startAddingRepayment()" *ngIf="!isAddingHistoryEntry()"
          style="background: linear-gradient(135deg, var(--success), #059669);">
          üí∞ Receive
        </button>
        <button class="btn-danger" (click)="deleteUser(selectedBorrower()!)">
          üóëÔ∏è Delete User
        </button>
      </div>
    </div>

    <div class="glass glass-card ledger-card">
      <table class="ledger-table">
        <thead>
          <tr>
            <th style="width: 80px;">
              <input type="checkbox" [checked]="isAllSelected()" (change)="toggleSelectAll()" class="ledger-checkbox">
            </th>
            <th>Date</th>
            <th>Type</th>
            <th>Description</th>
            <th>Amount</th>
            <th style="text-align: right;">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (t of getBorrowerTransactions(selectedBorrower()!); track t.id) {
          <!-- Main Loan Entry -->
          <tr [class.editing-row]="editingTransactionId() === t.id"
            [class.selected-row]="selectedTransactionIds().has(t.id)">
            <td>
              <input type="checkbox" [checked]="selectedTransactionIds().has(t.id)" (change)="toggleSelection(t.id)"
                class="ledger-checkbox">
            </td>

            <ng-container *ngIf="editingTransactionId() !== t.id">
              <td>{{ t.dateGiven | date:'dd MMM yyyy' }}</td>
              <td><span class="status-badge active">Loan Disbursed</span></td>
              <td style="color: var(--text-med)">{{ t.frequency }} ({{ t.percentage }}%)</td>
              <td style="font-weight: 700;">{{ t.amountGiven | currency:'INR':'symbol':'1.0-0' }}</td>
              <td style="text-align: right;">
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                  <button class="btn-primary" style="padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.8rem;"
                    (click)="startEditingTransaction(t)">Edit</button>
                  <button class="btn-danger" style="padding: 0.4rem 0.6rem; border-radius: 8px;"
                    (click)="deleteLoan(t)">üóëÔ∏è</button>
                </div>
              </td>
            </ng-container>

            <ng-container *ngIf="editingTransactionId() === t.id">
              <td><input [(ngModel)]="newEntryDate" type="date" class="ledger-input"></td>
              <td><span class="status-badge active">Editing</span></td>
              <td>-</td>
              <td><input [(ngModel)]="newEntryAmount" type="number" class="ledger-input"></td>
              <td style="text-align: right;">
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                  <button class="btn-primary" (click)="saveTransactionEdit(t)">Save</button>
                  <button class="btn-danger" (click)="cancelTransactionEdit()">‚úï</button>
                </div>
              </td>
            </ng-container>
          </tr>

          <!-- Payment Progress Bar -->
          <tr class="progress-row" *ngIf="editingTransactionId() !== t.id">
            <td colspan="6" style="padding: 0 1rem 0.75rem;">
              <div class="loan-progress-container">
                <div class="loan-progress-info">
                  <span class="progress-label">Repaid: {{ loanService.getAmountReceived(t) |
                    currency:'INR':'symbol':'1.0-0' }} / {{ t.amountGiven | currency:'INR':'symbol':'1.0-0' }}</span>
                  <span class="progress-pct">{{ (t.amountGiven > 0 ? (loanService.getAmountReceived(t) / t.amountGiven *
                    100) : 0) | number:'1.0-0' }}%</span>
                </div>
                <div class="loan-progress-track">
                  <div class="loan-progress-fill"
                    [style.width.%]="t.amountGiven > 0 ? (loanService.getAmountReceived(t) / t.amountGiven * 100) : 0"
                    [class.complete]="loanService.getAmountReceived(t) >= t.amountGiven"
                    [class.warning]="loanService.getAmountReceived(t) < t.amountGiven * 0.5 && loanService.getAmountReceived(t) > 0">
                  </div>
                </div>
                <button *ngIf="loanService.getAmountReceived(t) < t.amountGiven" class="btn-remind"
                  (click)="sendReminder(t)" title="Send Payment Reminder">
                  üì≤ Remind
                </button>
              </div>
            </td>
          </tr>

          <!-- Repayments -->
          @for (r of t.repayments; track r.id || $index) {
          <tr class="repayment-detail-row" [class.selected-row]="selectedTransactionIds().has(r.id || $index)">
            <td>
              <input type="checkbox" [checked]="selectedTransactionIds().has(r.id || $index)"
                (change)="toggleSelection(r.id || $index)" class="ledger-checkbox">
            </td>

            <ng-container *ngIf="editingRepaymentId() !== (t.id + '_' + (r.id || $index))">
              <td>{{ r.date | date:'dd MMM yyyy' }}</td>
              <td><span class="status-badge paid-off">Repayment</span></td>
              <td style="color: var(--text-med)">Payment Received</td>
              <td style="font-weight: 700; color: var(--success)">- {{ r.amount | currency:'INR':'symbol':'1.0-0' }}
              </td>
              <td style="text-align: right;">
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                  <button class="btn-primary" style="padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.8rem;"
                    (click)="startEditingRepayment(t, r, $index)">Edit</button>
                  <button class="btn-danger" style="padding: 0.4rem 0.6rem; border-radius: 8px;"
                    (click)="loanService.deleteRepayment(t.id, r.id || $index)">üóëÔ∏è</button>
                </div>
              </td>
            </ng-container>

            <ng-container *ngIf="editingRepaymentId() === (t.id + '_' + (r.id || $index))">
              <td><input [(ngModel)]="newEntryDate" type="date" class="ledger-input"></td>
              <td><span class="status-badge active">Editing</span></td>
              <td>Payment Received</td>
              <td><input [(ngModel)]="newEntryAmount" type="number" class="ledger-input"></td>
              <td style="text-align: right;">
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                  <button class="btn-primary" (click)="saveRepaymentEdit(t, r, $index)">Save</button>
                  <button class="btn-danger" (click)="cancelRepaymentEdit()">‚úï</button>
                </div>
              </td>
            </ng-container>
          </tr>
          }
          }

          <!-- Quick Add Entry Row -->
          <tr class="add-entry-row" *ngIf="isAddingHistoryEntry()">
            <td></td>
            <td><input [(ngModel)]="newEntryDate" type="date" class="ledger-input"></td>
            <td>
              <select [(ngModel)]="newEntryType" class="ledger-input">
                <option value="Loan">New Loan</option>
                <option value="Repayment">New Repayment</option>
              </select>
            </td>
            <td><span style="color: var(--text-low); font-size: 0.8rem">Quick Record</span></td>
            <td>
              <input [(ngModel)]="newEntryAmount" type="number" placeholder="Amount" class="ledger-input">
            </td>
            <td style="text-align: right;">
              <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn-primary" (click)="addHistoryEntry()">Record</button>
                <button class="btn-danger" (click)="cancelAddingHistory()">‚úï</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    } @else {
    <!-- Empty State / Dashboard -->
    <div class="stats-row" *ngIf="currentTab() === 'dashboard'">
      <div class="glass glass-card stat-card">
        <span class="stat-label">Capital Out</span>
        <span class="stat-value">{{ totalLent() | currency:'INR':'symbol':'1.0-0' }}</span>
      </div>
      <div class="glass glass-card stat-card">
        <span class="stat-label">Total Repaid</span>
        <span class="stat-value" style="color: var(--success);">{{ totalRepaid() | currency:'INR':'symbol':'1.0-0'
          }}</span>
      </div>
      <div class="glass glass-card stat-card">
        <span class="stat-label">Outstanding</span>
        <span class="stat-value" style="color: var(--accent);">{{ outstanding() | currency:'INR':'symbol':'1.0-0'
          }}</span>
      </div>
      <div class="glass glass-card stat-card">
        <span class="stat-label">Active Loans</span>
        <span class="stat-value">{{ activeLoans() }}</span>
      </div>
    </div>

    <!-- ===== OVERDUE ALERTS ===== -->
    <div class="overdue-alert glass" *ngIf="currentTab() === 'dashboard' && overdueLoans().length > 0">
      <div class="overdue-alert-header">
        <div style="display: flex; align-items: center; gap: 12px;">
          <span class="overdue-pulse-badge">{{ overdueLoans().length }}</span>
          <div>
            <div style="font-weight: 700; font-size: 1.1rem; color: var(--error);">Overdue Alerts</div>
            <div style="font-size: 0.85rem; color: var(--text-med);">Loans past 90 days with less than 50% repaid</div>
          </div>
        </div>
      </div>
      <div class="overdue-list">
        <div class="overdue-item" *ngFor="let o of overdueLoans()">
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 1.2rem;">‚ö†Ô∏è</span>
            <div>
              <div style="font-weight: 700; color: var(--text-pure);">{{ o.name }}</div>
              <div style="font-size: 0.8rem; color: var(--text-med);">{{ o.daysSince }} days overdue ¬∑ {{ o.repaidRatio
                }}% repaid</div>
            </div>
          </div>
          <div style="font-weight: 800; color: var(--error); font-size: 1.1rem;">
            {{ o.amount | currency:'INR':'symbol':'1.0-0' }}
          </div>
        </div>
      </div>
    </div>

    <!-- ===== ANALYTICS GRID: Pie Chart + Interest Tracker ===== -->
    <div class="analytics-grid" *ngIf="currentTab() === 'dashboard'">
      <!-- Pie Chart Widget -->
      <div class="glass glass-card pie-chart-widget">
        <h3 class="widget-title">Loan Status Breakdown</h3>
        <div class="pie-chart-container">
          <svg viewBox="0 0 100 100" class="pie-svg" *ngIf="loanStatusBreakdown().total > 0">
            <!-- Active slice -->
            <path *ngIf="loanStatusBreakdown().active > 0"
              [attr.d]="getPieSlicePath(0, loanStatusBreakdown().active / loanStatusBreakdown().total * 360)"
              fill="#10b981" class="pie-slice" />
            <!-- Paid Off slice -->
            <path *ngIf="loanStatusBreakdown().paidOff > 0" [attr.d]="getPieSlicePath(
                loanStatusBreakdown().active / loanStatusBreakdown().total * 360,
                (loanStatusBreakdown().active + loanStatusBreakdown().paidOff) / loanStatusBreakdown().total * 360
              )" fill="#6366f1" class="pie-slice" />
            <!-- Overdue slice -->
            <path *ngIf="loanStatusBreakdown().overdue > 0" [attr.d]="getPieSlicePath(
                (loanStatusBreakdown().active + loanStatusBreakdown().paidOff) / loanStatusBreakdown().total * 360,
                (loanStatusBreakdown().active + loanStatusBreakdown().paidOff + loanStatusBreakdown().overdue) / loanStatusBreakdown().total * 360
              )" fill="#ef4444" class="pie-slice" />
            <!-- Profit slice -->
            <path *ngIf="loanStatusBreakdown().profit > 0" [attr.d]="getPieSlicePath(
                (loanStatusBreakdown().active + loanStatusBreakdown().paidOff + loanStatusBreakdown().overdue) / loanStatusBreakdown().total * 360,
                360
              )" fill="#00f2ff" class="pie-slice" />
            <!-- Center circle for donut effect -->
            <circle cx="50" cy="50" r="22" fill="var(--bg-dark)" />
            <text x="50" y="48" text-anchor="middle" fill="var(--text-pure)" font-size="8" font-weight="800">{{
              loanStatusBreakdown().total }}</text>
            <text x="50" y="57" text-anchor="middle" fill="var(--text-med)" font-size="4">LOANS</text>
          </svg>
          <div *ngIf="loanStatusBreakdown().total === 0"
            style="text-align: center; padding: 2rem; color: var(--text-med);">
            No loan data yet
          </div>
        </div>
        <div class="pie-legend">
          <div class="legend-item">
            <span class="legend-dot" style="background: #10b981;"></span>
            <span>Active ({{ loanStatusBreakdown().active }})</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot" style="background: #6366f1;"></span>
            <span>Paid Off ({{ loanStatusBreakdown().paidOff }})</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot" style="background: #ef4444;"></span>
            <span>Overdue ({{ loanStatusBreakdown().overdue }})</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot" style="background: #00f2ff;"></span>
            <span>Profit ({{ loanStatusBreakdown().profit }})</span>
          </div>
        </div>
      </div>

      <!-- Interest Earned Tracker -->
      <div class="glass glass-card interest-tracker-widget">
        <h3 class="widget-title">Interest Earned Tracker</h3>
        <div class="interest-stats">
          <div class="interest-stat-row">
            <span class="interest-label">Total Principal</span>
            <span class="interest-value">{{ interestStats().totalPrincipal | currency:'INR':'symbol':'1.0-0' }}</span>
          </div>
          <div class="interest-stat-row">
            <span class="interest-label">Total Received</span>
            <span class="interest-value" style="color: var(--success);">{{ interestStats().totalReceived |
              currency:'INR':'symbol':'1.0-0' }}</span>
          </div>
          <div class="interest-stat-row highlight">
            <span class="interest-label">üí∞ Interest Earned</span>
            <span class="interest-value glow-text">{{ interestStats().interestEarned | currency:'INR':'symbol':'1.0-0'
              }}</span>
          </div>
        </div>
        <div class="progress-container">
          <div class="progress-label">
            <span>Return on Capital</span>
            <span style="color: var(--accent); font-weight: 700;">{{ interestStats().ratio | number:'1.1-1' }}%</span>
          </div>
          <div class="progress-bar-track">
            <div class="progress-bar-fill" [style.width.%]="interestStats().ratio > 100 ? 100 : interestStats().ratio">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== TOP BORROWERS ===== -->
    <div class="analytics-grid" *ngIf="currentTab() === 'dashboard'">
      <!-- Highest Outstanding -->
      <div class="glass glass-card top-borrowers-widget">
        <h3 class="widget-title">üî¥ Highest Outstanding</h3>
        <div class="top-borrower-list">
          <div class="top-borrower-item" *ngFor="let b of topBorrowers().byOutstanding; let i = index">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span class="rank-badge" [style.background]="i === 0 ? 'var(--error)' : 'rgba(255,255,255,0.05)'">{{ i + 1
                }}</span>
              <span style="font-weight: 600; color: var(--text-pure);">{{ b.name }}</span>
            </div>
            <span style="font-weight: 800; color: var(--error);">{{ b.outstanding | currency:'INR':'symbol':'1.0-0'
              }}</span>
          </div>
          <div *ngIf="topBorrowers().byOutstanding.length === 0"
            style="text-align: center; padding: 1.5rem; color: var(--text-med); font-size: 0.9rem;">
            No outstanding loans
          </div>
        </div>
      </div>

      <!-- Most Profitable -->
      <div class="glass glass-card top-borrowers-widget">
        <h3 class="widget-title">üü¢ Most Profitable</h3>
        <div class="top-borrower-list">
          <div class="top-borrower-item" *ngFor="let b of topBorrowers().byProfit; let i = index">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span class="rank-badge" [style.background]="i === 0 ? 'var(--success)' : 'rgba(255,255,255,0.05)'">{{ i +
                1 }}</span>
              <span style="font-weight: 600; color: var(--text-pure);">{{ b.name }}</span>
            </div>
            <span style="font-weight: 800; color: var(--success);">{{ b.profit | currency:'INR':'symbol':'1.0-0'
              }}</span>
          </div>
          <div *ngIf="topBorrowers().byProfit.length === 0"
            style="text-align: center; padding: 1.5rem; color: var(--text-med); font-size: 0.9rem;">
            No profit data yet
          </div>
        </div>
      </div>
    </div>

    <!-- Directory Content -->
    <div class="glass glass-card" *ngIf="currentTab() === 'loans'" style="padding: 0 !important;">
      <table class="ledger-table">
        <thead>
          <tr>
            <th style="width: 250px;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <span>Borrower</span>
                <button class="btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;"
                  (click)="openAddBorrower()">
                  + Add
                </button>
              </div>
            </th>
            <th>Status</th>
            <th>Total Lent</th>
            <th>Received</th>
            <th>Outstanding</th>
            <th style="text-align: right;">Active Loans</th>
            <th style="text-align: right;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let b of borrowers()" style="transition: background 0.2s;">
            <td (click)="selectedBorrower.set(b.name)"
              style="cursor: pointer; font-size: 1.1rem; font-weight: 700; color: var(--primary)">
              {{ b.name }}
              <div style="font-size: 0.8rem; color: var(--text-med); font-weight: 400;" *ngIf="b.phone">{{ b.phone }}
              </div>
            </td>
            <td>
              <span class="status-badge" [class.active]="b.status === 'Active'"
                [class.profit]="b.status === 'Profitable'" [class.paid-off]="b.status === 'Settled'">
                {{ b.status }}
              </span>
            </td>
            <td style="font-weight: 600;">{{ b.totalLent | currency:'INR':'symbol':'1.0-0' }}</td>
            <td style="color: var(--success); font-weight: 600;">{{ b.totalReceived | currency:'INR':'symbol':'1.0-0' }}
            </td>
            <td style="color: var(--error); font-weight: 700;">{{ b.outstanding | currency:'INR':'symbol':'1.0-0' }}
            </td>
            <td style="text-align: right; font-weight: 600; color: var(--text-med)">{{ b.activeLoans }}</td>
            <td style="text-align: right;">
              <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn-primary" (click)="selectedBorrower.set(b.name)"
                  style="padding: 0.5rem 1rem; font-size: 0.85rem;">View</button>
                <button class="btn-danger" (click)="deleteUser(b.name)" style="padding: 0.5rem 0.8rem;">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>


    <!-- Statistics Content -->
    <div class="glass glass-card" *ngIf="currentTab() === 'borrowers'" style="padding: 2rem !important;">
      <h2
        style="margin-top: 0; margin-bottom: 2rem; font-size: 1.5rem; background: linear-gradient(135deg, white, var(--primary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
        Monthly Repayment Trends
      </h2>

      <div style="height: 300px; width: 100%; position: relative;">
        <!-- Chart SVG -->
        <svg viewBox="0 0 100 50" style="width: 100%; height: 100%; overflow: visible;" preserveAspectRatio="none">
          <!-- Gradient Defs -->
          <defs>
            <linearGradient id="chartGradient" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0%" stop-color="var(--primary)" stop-opacity="0.4" />
              <stop offset="100%" stop-color="var(--primary)" stop-opacity="0" />
            </linearGradient>
          </defs>

          <!-- Grid Lines -->
          <line x1="0" y1="10" x2="100" y2="10" stroke="rgba(255,255,255,0.05)" stroke-width="0.2" />
          <line x1="0" y1="25" x2="100" y2="25" stroke="rgba(255,255,255,0.05)" stroke-width="0.2" />
          <line x1="0" y1="40" x2="100" y2="40" stroke="rgba(255,255,255,0.05)" stroke-width="0.2" />

          <!-- Area Fill -->
          <path [attr.d]="getChartPath(true)" fill="url(#chartGradient)" stroke="none" />

          <!-- Line Stroke -->
          <path [attr.d]="getChartPath(false)" fill="none" stroke="var(--primary)" stroke-width="0.8"
            stroke-linecap="round" stroke-linejoin="round" class="chart-line" />
        </svg>

        <!-- Labels Overlay -->
        <div
          style="position: absolute; bottom: -25px; left: 0; width: 100%; display: flex; justify-content: space-between; padding: 0 10px;">
          <span *ngFor="let m of monthlyStats()" style="font-size: 0.75rem; color: var(--text-med);">{{ m.label
            }}</span>
        </div>
      </div>

      <div
        style="margin-top: 4rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
        <div *ngFor="let m of monthlyStats()" class="glass"
          style="padding: 1rem; border-radius: 16px; background: rgba(255,255,255,0.02);">
          <div style="font-size: 0.85rem; color: var(--text-med); margin-bottom: 0.5rem;">{{ m.label }}</div>
          <div style="font-size: 1.2rem; font-weight: 700; color: var(--text-pure);">{{ m.value |
            currency:'INR':'symbol':'1.0-0' }}</div>
        </div>
      </div>
    </div>
    }



    <!-- Settings View -->
    <div *ngIf="currentTab() === 'settings'" style="padding: 2rem; display: flex; justify-content: center;">
      <app-profile-settings style="width: 100%; max-width: 600px;"></app-profile-settings>
    </div>

    <!-- Modals -->
    <!-- Add Borrower Modal -->
    <div class="modal-overlay" *ngIf="showAddBorrowerModal()">
      <div class="glass glass-card modal-content">
        <h2>Add New Borrower</h2>

        <div class="form-group">
          <label>Full Name</label>
          <input type="text" [ngModel]="newBorrowerName()" (ngModelChange)="newBorrowerName.set($event)"
            placeholder="e.g. John Doe">
        </div>

        <div class="form-group">
          <label>Phone Number (Optional)</label>
          <input type="text" [ngModel]="newBorrowerPhone()" (ngModelChange)="newBorrowerPhone.set($event)"
            placeholder="+91 98765 43210">
        </div>

        <div class="form-group">
          <label>Notes (Optional)</label>
          <textarea [ngModel]="newBorrowerNotes()" (ngModelChange)="newBorrowerNotes.set($event)"
            placeholder="Address, Reference, etc." rows="3"></textarea>
        </div>

        <div class="modal-actions">
          <button class="btn-primary" (click)="saveBorrower()">Create Profile</button>
          <button class="btn-danger" (click)="showAddBorrowerModal.set(false)">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Add Transaction Modal -->
    <div class="modal-overlay" *ngIf="showAddTransactionModal()">
      <div class="glass glass-card modal-content" style="max-width: 600px;">
        <h2>New Transaction for {{ selectedBorrower() }}</h2>

        <div class="grid-2">
          <div class="form-group">
            <label>Amount (‚Çπ)</label>
            <input type="number" [ngModel]="amountGiven()" (ngModelChange)="amountGiven.set($event)"
              placeholder="50000">
          </div>

          <div class="form-group">
            <label>Date Given</label>
            <input type="date" [ngModel]="dateGiven()" (ngModelChange)="dateGiven.set($event)">
          </div>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label>Interest Rate (%)</label>
            <input type="number" [ngModel]="percentage()" (ngModelChange)="percentage.set($event)" placeholder="3">
          </div>

          <div class="form-group">
            <label>Frequency</label>
            <select [ngModel]="frequency()" (ngModelChange)="frequency.set($event)">
              <option value="Monthly">Monthly</option>
              <option value="Weekly">Weekly</option>
            </select>
          </div>
        </div>

        <div class="form-group" style="margin-top: 1rem;">
          <label>Installment Amount (Optional/Guide)</label>
          <input type="number" [ngModel]="installmentAmount()" (ngModelChange)="installmentAmount.set($event)"
            placeholder="Expected payment per period">
        </div>

        <div class="modal-actions">
          <button class="btn-primary" (click)="saveTransaction()">Record Transaction</button>
          <button class="btn-danger" (click)="showAddTransactionModal.set(false)">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Loan Calculator Modal -->
    <div class="modal-overlay" *ngIf="showCalculator()">
      <div class="glass glass-card modal-content" style="max-width: 500px;">
        <h2>üßÆ Loan Calculator</h2>

        <div class="grid-2">
          <div class="form-group">
            <label>Principal Amount (‚Çπ)</label>
            <input type="number" [ngModel]="calcPrincipal()" (ngModelChange)="calcPrincipal.set($event)"
              placeholder="100000">
          </div>
          <div class="form-group">
            <label>Interest Rate (%)</label>
            <input type="number" [ngModel]="calcRate()" (ngModelChange)="calcRate.set($event)" placeholder="3">
          </div>
        </div>

        <div class="grid-2">
          <div class="form-group">
            <label>Tenure (Periods)</label>
            <input type="number" [ngModel]="calcTenure()" (ngModelChange)="calcTenure.set($event)" placeholder="12">
          </div>
          <div class="form-group">
            <label>Frequency</label>
            <select [ngModel]="calcFrequency()" (ngModelChange)="calcFrequency.set($event)">
              <option value="Monthly">Monthly</option>
              <option value="Weekly">Weekly</option>
            </select>
          </div>
        </div>

        <div class="calc-results" *ngIf="calcResult() as r">
          <div class="calc-result-item">
            <span class="calc-result-label">EMI / Installment</span>
            <span class="calc-result-value" style="color: var(--primary)">{{ r.emi | currency:'INR':'symbol':'1.0-0'
              }}</span>
          </div>
          <div class="calc-result-item">
            <span class="calc-result-label">Total Interest</span>
            <span class="calc-result-value" style="color: var(--accent)">{{ r.totalInterest |
              currency:'INR':'symbol':'1.0-0' }}</span>
          </div>
          <div class="calc-result-item">
            <span class="calc-result-label">Total Payable</span>
            <span class="calc-result-value" style="color: var(--success)">{{ r.totalPayable |
              currency:'INR':'symbol':'1.0-0' }}</span>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn-danger" (click)="showCalculator.set(false)">Close</button>
        </div>
      </div>
    </div>

    <!-- Audit Log Section (in Dashboard) -->
    <div class="glass glass-card" *ngIf="currentTab() === 'dashboard' && auditLog().length > 0"
      style="margin-top: 1rem;">
      <h3 class="widget-title" style="margin-bottom: 1rem;">üìã Recent Activity</h3>
      <div class="audit-log-list">
        <div class="audit-item" *ngFor="let entry of auditLog().slice(0, 10)">
          <div class="audit-icon" [ngSwitch]="entry.type">
            <span *ngSwitchCase="'create'">‚ûï</span>
            <span *ngSwitchCase="'delete'">üóëÔ∏è</span>
            <span *ngSwitchCase="'update'">‚úèÔ∏è</span>
            <span *ngSwitchCase="'payment'">üí∞</span>
            <span *ngSwitchCase="'reminder'">üì≤</span>
            <span *ngSwitchDefault>üìù</span>
          </div>
          <div class="audit-content">
            <span class="audit-message">{{ entry.message }}</span>
            <span class="audit-time">{{ entry.timestamp | date:'dd MMM, h:mm a' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== FLOATING ACTION BUTTON ===== -->
    <div class="fab-backdrop" *ngIf="fabOpen()" (click)="fabOpen.set(false)"></div>
    <div class="fab-container">
      <div class="fab-actions" [class.open]="fabOpen()">
        <button class="fab-action" (click)="fabOpen.set(false); showCalculator.set(true)" title="Loan Calculator">
          <span style="font-size: 1.2rem;">üßÆ</span>
          <span class="fab-label">Calculator</span>
        </button>
        <button class="fab-action" (click)="fabOpen.set(false); showAddBorrowerModal.set(true)" title="Add Borrower">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="8.5" cy="7" r="4"></circle>
            <line x1="20" y1="8" x2="20" y2="14"></line>
            <line x1="23" y1="11" x2="17" y2="11"></line>
          </svg>
          <span class="fab-label">Add Borrower</span>
        </button>
        <button class="fab-action fab-action-lend" *ngIf="selectedBorrower()"
          (click)="fabOpen.set(false); openAddTransaction()" title="Quick Lend">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
          <span class="fab-label">Quick Lend</span>
        </button>
        <button class="fab-action fab-action-receive" *ngIf="selectedBorrower()"
          (click)="fabOpen.set(false); startAddingRepayment()" title="Receive Payment">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 12 20 22 4 22 4 12"></polyline>
            <rect x="2" y="7" width="20" height="5"></rect>
            <line x1="12" y1="22" x2="12" y2="7"></line>
            <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path>
            <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>
          </svg>
          <span class="fab-label">Receive Payment</span>
        </button>
      </div>
      <button class="fab-main" [class.open]="fabOpen()" (click)="fabOpen.set(!fabOpen())">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
          stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </button>
    </div>

  </main>
</div>
} @else {
<router-outlet></router-outlet>
}